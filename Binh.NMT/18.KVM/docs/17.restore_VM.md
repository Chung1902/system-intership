# Cách restore lại VM trong trường hợp máy ảo bị chết
Nếu VM bị chết sau khi migrate hoặc mất domain định nghĩa, có một số cách khôi phục tùy theo tình huống cụ thể:
## 1. Trường hợp vẫn còn file disk image (.qcow2, .img)
- Kiểm tra lại thư mục chứa disk:
```
/var/lib/libvirt/images/
```
- Nếu file còn, bạn chỉ cần tạo lại domain XML:
```
virsh define /path/to/domain.xml
```
- Nếu không có domain.xml backup, có thể tạo mới bằng virt-install hoặc virsh create rồi chỉ định file qcow2 làm disk:
```
virt-install --name restored-vm \
  --ram 2048 --vcpus 2 \
  --disk path=/var/lib/libvirt/images/vm.qcow2 \
  --import --network network=default --noautoconsole
```
## 2. Trường hợp VM bị undefine nhưng file XML backup vẫn còn
- Nếu trước đó bạn có backup domain config:
```
virsh define /path/to/backup.xml
```
- Domain sẽ trở lại như cũ, dùng lại file qcow2 hiện có.
## 3. Nếu cả disk và domain.xml đều mất
- Cần khôi phục từ backup hệ thống hoặc snapshot (nếu có).
- Nếu storage nằm trên LVM/ZFS/CEPH → có thể rollback snapshot.
- Nếu không có backup, VM coi như mất hoàn toàn.
## 4. Khôi phục từ snapshot
- Luôn backup domain XML:
```
virsh dumpxml vmname > vmname.xml
```
- Luôn backup disk image trước khi migrate hoặc clone VM trước khi migrate.
- Tạo snapshot để phòng ngừa trường hợp máy bảo chết, có thể thực hiện thông qua giao diện GUI virt-manager hoặc sử dụng câu lệnh:
```
virsh snapshot-create-as --domain tên_máy --name tên_bản_snapshot --description "mô tả bản snapshot"
```